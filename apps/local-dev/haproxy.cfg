global
  log stdout format raw local0
  maxconn 20000
  tune.bufsize 32768

defaults
  mode http
  option httplog
  timeout connect 2s
  timeout client 30s
  timeout server 30s

# Docker interner DNS-Resolver (funktioniert ideal mit Swarm + endpoint_mode: dnsrr)
resolvers docker
  nameserver dns 127.0.0.11:53
  resolve_retries 30
  timeout resolve 1s
  hold valid 10s

frontend http-in
  bind *:80
  default_backend api-backend

backend api-backend
  balance roundrobin
  option httpchk GET /health
  http-check expect status 200
  # Dynamische Server-Liste aus DNS (Swarm gibt mehrere A-Records für api zurück)
  server-template api 10 api:3000 check resolvers docker init-addr libc,none
